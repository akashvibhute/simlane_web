{% extends "teams/club_dashboard/_base.html" %}
{% load static %}

{% block page_content %}
  <div class="space-y-6">
    <!-- Header with filters -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Join Requests</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
          Review and manage membership requests for {{ club.name }}.
        </p>
      </div>
      {% if pending_requests_count > 0 %}
        <div class="flex space-x-3">
          <button onclick="approveAllRequests()"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Approve All Pending
          </button>
        </div>
      {% endif %}
    </div>

    <!-- Status Filter Tabs with HTMX -->
    <div class="border-b border-gray-200 dark:border-gray-700">
      <nav class="-mb-px flex space-x-8">
        <button hx-get="{% url 'clubs:requests' club.slug %}?status=all"
                hx-target="#requests-list"
                hx-push-url="false"
                class="{% if current_filter == 'all' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600{% endif %} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
          All Requests
          <span class="ml-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-300 py-0.5 px-2.5 rounded-full text-xs">{{ total_requests }}</span>
        </button>
        <button hx-get="{% url 'clubs:requests' club.slug %}?status=pending"
                hx-target="#requests-list"
                hx-push-url="false"
                class="{% if current_filter == 'pending' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600{% endif %} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
          Pending
          <span class="ml-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 py-0.5 px-2.5 rounded-full text-xs">{{ pending_requests_count }}</span>
        </button>
        <button hx-get="{% url 'clubs:requests' club.slug %}?status=approved"
                hx-target="#requests-list"
                hx-push-url="false"
                class="{% if current_filter == 'approved' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600{% endif %} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
          Approved
          <span class="ml-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 py-0.5 px-2.5 rounded-full text-xs">{{ approved_requests_count }}</span>
        </button>
        <button hx-get="{% url 'clubs:requests' club.slug %}?status=rejected"
                hx-target="#requests-list"
                hx-push-url="false"
                class="{% if current_filter == 'rejected' %}border-primary-500 text-primary-600 dark:text-primary-400{% else %}border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600{% endif %} whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
          Rejected
          <span class="ml-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 py-0.5 px-2.5 rounded-full text-xs">{{ rejected_requests_count }}</span>
        </button>
      </nav>
    </div>

    <!-- Requests List Container -->
    <div id="requests-list">
      {% include "teams/club_dashboard/_requests_list.html" %}
    </div>
  </div>

  <!-- Scripts for request management -->
  <script>
    function approveRequest(requestId) {
      if (confirm('Are you sure you want to approve this request?')) {
        htmx.ajax('POST', `{% url 'teams:approve_join_request' club.slug 0 %}`.replace('0', requestId), {
          target: '#requests-list',
          swap: 'outerHTML'
        });
      }
    }
    
    function rejectRequest(requestId) {
      const reason = prompt('Please provide a reason for rejection (optional):');
      if (reason !== null) {
        htmx.ajax('POST', `{% url 'teams:reject_join_request' club.slug 0 %}`.replace('0', requestId), {
          target: '#requests-list',
          swap: 'outerHTML',
          values: {'reason': reason}
        });
      }
    }
    
    function approveAllRequests() {
      if (confirm('Are you sure you want to approve all pending requests?')) {
        htmx.ajax('POST', `{% url 'teams:bulk_approve_requests' club.slug %}`, {
          target: '#requests-list',
          swap: 'outerHTML'
        });
      }
    }
    
    function deleteRequest(requestId) {
      if (confirm('Are you sure you want to permanently delete this request? This action cannot be undone.')) {
        htmx.ajax('DELETE', `{% url 'teams:delete_join_request' club.slug 0 %}`.replace('0', requestId), {
          target: '#requests-list',
          swap: 'outerHTML'
        });
      }
    }
  </script>
{% endblock %} 
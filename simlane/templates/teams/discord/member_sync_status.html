{% load i18n %}
{% comment %} Template: Discord Member Sync Status {% endcomment %}

{% if sync and sync.status == 'in_progress' %}
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
            <svg class="w-5 h-5 text-blue-400 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <div class="flex-1">
            <h3 class="text-sm font-medium text-blue-800">{% trans "Member Sync in Progress" %}</h3>
            <p class="text-sm text-blue-700">
                {% trans "Syncing Discord members with club membership. This may take a few minutes to complete." %}
            </p>
            {% if sync.progress %}
            <div class="w-full bg-blue-100 rounded-full h-2 mt-3">
                <div class="bg-blue-500 h-2 rounded-full" style="width: {{ sync.progress }}%;"></div>
            </div>
            <p class="text-xs text-blue-600 mt-1">{{ sync.progress }}%</p>
            {% endif %}
        </div>
    </div>
</div>

{% elif sync and sync.status == 'completed' %}
<div class="bg-green-50 border border-green-200 rounded-lg p-4">
    <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
            <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 10-1.414 1.414L9 13.414l4.707-4.707z" clip-rule="evenodd" />
            </svg>
        </div>
        <div>
            <h3 class="text-sm font-medium text-green-800">{% trans "Member Sync Completed" %}</h3>
            <p class="text-sm text-green-700">
                {% blocktrans %}Matched {{ sync.matched_count }} members, {{ sync.unmatched_count }} unmatched, {{ sync.error_count }} errors.{% endblocktrans %}
            </p>
            <p class="text-xs text-green-600 mt-1">
                {% trans "Completed at" %} {{ sync.end_time|date:"SHORT_DATETIME_FORMAT" }}
            </p>
        </div>
    </div>
</div>

{% if sync.unmatched_count and unmatched_users %}
<div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
    <h4 class="text-sm font-medium text-yellow-800">{% blocktrans %}Unmatched Discord Users ({{ sync.unmatched_count }}){% endblocktrans %}</h4>
    <ul class="list-disc pl-5 mt-2 text-sm text-yellow-700">
        {% for user in unmatched_users %}
            <li>{{ user.username }} (ID: {{ user.discord_id }})</li>
        {% endfor %}
    </ul>
    <div class="mt-3">
        <a href="{% url 'club_discord_resolve_conflicts' club.slug %}" class="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
            {% trans "Resolve Conflicts" %}
        </a>
    </div>
</div>
{% endif %}

{% if sync.error_count and error_messages %}
<div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <h4 class="text-sm font-medium text-red-800">{% blocktrans %}Sync Errors ({{ sync.error_count }}){% endblocktrans %}</h4>
    <ul class="list-disc pl-5 mt-2 text-sm text-red-700">
        {% for err in error_messages %}
            <li>{{ err }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="mt-4 flex space-x-2">
    <a href="{% url 'club_discord_sync_members' club.slug %}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
        {% trans "Sync Now" %}
    </a>
    {% if sync.log_url %}
    <a href="{{ sync.log_url }}" target="_blank" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm">
        {% trans "View Logs" %}
    </a>
    {% endif %}
</div>

{% elif sync and sync.status == 'failed' %}
<div class="bg-red-50 border border-red-200 rounded-lg p-4">
    <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
            <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-9V5a1 1 0 112 0v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H5a1 1 0 110-2h4z" clip-rule="evenodd" />
            </svg>
        </div>
        <div>
            <h3 class="text-sm font-medium text-red-800">{% trans "Member Sync Failed" %}</h3>
            <p class="text-sm text-red-700">
                {% trans "An error occurred during the sync process. Please check the logs and try again." %}
            </p>
        </div>
    </div>
</div>

{% if error_messages %}
<div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
    <h4 class="text-sm font-medium text-red-800">{% trans "Error Details" %}</h4>
    <ul class="list-disc pl-5 mt-2 text-sm text-red-700">
        {% for err in error_messages %}
            <li>{{ err }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="mt-4 flex space-x-2">
    <a href="{% url 'club_discord_sync_members' club.slug %}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
        {% trans "Retry Sync" %}
    </a>
    {% if sync.log_url %}
    <a href="{{ sync.log_url }}" target="_blank" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 text-sm">
        {% trans "View Logs" %}
    </a>
    {% endif %}
</div>

{% else %}
<div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
    <h3 class="text-sm font-medium text-gray-800">{% trans "Member Sync Status" %}</h3>
    <p class="text-sm text-gray-700">
        {% trans "No sync has been run yet. Click below to start syncing members." %}
    </p>
    <div class="mt-4">
        <a href="{% url 'club_discord_sync_members' club.slug %}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
            {% trans "Start Sync" %}
        </a>
    </div>
</div>
{% endif %}

{# Sync history #}
{% if history %}
<div class="mt-6">
    <h4 class="text-sm font-medium text-gray-800">{% trans "Sync History" %}</h4>
    <div class="mt-2 overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left text-gray-600">{% trans "Time" %}</th>
                    <th class="px-4 py-2 text-left text-gray-600">{% trans "Status" %}</th>
                    <th class="px-4 py-2 text-right text-gray-600">{% trans "Matched" %}</th>
                    <th class="px-4 py-2 text-right text-gray-600">{% trans "Unmatched" %}</th>
                    <th class="px-4 py-2 text-right text-gray-600">{% trans "Errors" %}</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for entry in history %}
                <tr>
                    <td class="px-4 py-2 whitespace-nowrap">{{ entry.timestamp|date:"SHORT_DATETIME_FORMAT" }}</td>
                    <td class="px-4 py-2 whitespace-nowrap">
                        {% if entry.status == 'completed' %}
                            <span class="text-green-600">{% trans "Completed" %}</span>
                        {% elif entry.status == 'in_progress' %}
                            <span class="text-blue-600">{% trans "In Progress" %}</span>
                        {% elif entry.status == 'failed' %}
                            <span class="text-red-600">{% trans "Failed" %}</span>
                        {% else %}
                            <span class="text-gray-600">{{ entry.status }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-right">{{ entry.matched_count }}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-right">{{ entry.unmatched_count }}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-right">{{ entry.error_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% comment %}Tracks list results partial - contains only the grid and pagination for HTMX updates{% endcomment %}
<div id="tracks-container">
  <!-- Skeleton Loader (visible during HTMX requests) -->
  <c-skeleton-grid count="3" class="htmx-indicator" id="loading-indicator"></c-skeleton-grid>
  <!-- Tracks Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    {% for track in page_obj %}
      <div class="bg-gray-100 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-shadow">
        {% with fallback_image=track.get_logo %}
          <div class="w-full h-48 flex items-center justify-center relative bg-gray-300 dark:bg-gray-700 shadow-sm">
            {% if track.default_image_url %}
              <img src="{{ track.default_image_url }}"
                   alt="{{ track.name }}"
                   class="max-h-40 max-w-full object-contain p-4 dark:brightness-125 "
                   style="background: none" />
            {% elif fallback_image %}
              <img src="{{ fallback_image.url }}"
                   alt="{{ track.name }}"
                   class="max-h-40 max-w-full object-contain p-4 dark:brightness-125"
                   style="background: none" />
            {% else %}
              <div class="w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                <svg class="w-16 h-16 text-gray-400"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-1.342l7.106-3.553a1 1 0 01.894 0l7.106 3.553A1 1 0 0121 5.618v10.764a1 1 0 01-.553.894L15 20a1 1 0 01-1 0z" />
                </svg>
              </div>
            {% endif %}
          </div>
        {% endwith %}
        <div class="p-4">
          <h3 class="font-semibold text-lg text-gray-900 dark:text-white mb-1">{{ track.name }}</h3>
          <div class="flex items-center justify-between mb-3">
            {% if track.country %}
              <span class="text-sm text-gray-500 dark:text-gray-400">
                {% if track.location %}{{ track.location }},{% endif %}
                {{ track.country }}
              </span>
            {% endif %}
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {{ track.layout_count }} layout{{ track.layout_count|pluralize }}
            </span>
          </div>
          <!-- Simulator Badges -->
          <div class="flex flex-wrap gap-1 mb-3">
            {% for sim_track in track.active_sim_tracks|slice:":4" %}
              <div class="relative group">
                {% if sim_track.simulator.icon %}
                  <img src="{{ sim_track.simulator.icon.url }}"
                       alt="{{ sim_track.simulator.name }}"
                       title="{{ sim_track.simulator.name }}"
                       class="w-6 h-6 rounded" />
                {% else %}
                  <div class="w-6 h-6 bg-primary-500 rounded flex items-center justify-center"
                       title="{{ sim_track.simulator.name }}">
                    <span class="text-xs font-bold text-white">{{ sim_track.simulator.name|first }}</span>
                  </div>
                {% endif %}
                {% if sim_track.is_laser_scanned %}
                  <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full"
                       title="Laser Scanned"></div>
                {% endif %}
              </div>
            {% endfor %}
            {% if track.simulator_count > 4 %}
              <span class="text-xs text-gray-500 dark:text-gray-400 ml-1">+{{ track.simulator_count|add:"-4" }}</span>
            {% endif %}
          </div>
          <a href="{% url 'track_detail' track.slug %}"
             class="btn-primary btn-sm w-full">View Details</a>
        </div>
      </div>
    {% empty %}
      <div class="col-span-full text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">No tracks found matching your criteria.</p>
      </div>
    {% endfor %}
  </div>
  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
    <div class="flex justify-center">
      <nav class="flex space-x-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_simulator %}&simulator={{ selected_simulator }}{% endif %}{% if selected_country %}&country={{ selected_country }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if laser_scanned_only %}&laser_scanned=true{% endif %}"
             hx-get="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_simulator %}&simulator={{ selected_simulator }}{% endif %}{% if selected_country %}&country={{ selected_country }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if laser_scanned_only %}&laser_scanned=true{% endif %}"
             hx-target="#tracks-container"
             hx-push-url="true"
             class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
            Previous
          </a>
        {% endif %}
        <span class="px-3 py-2 rounded-md bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_simulator %}&simulator={{ selected_simulator }}{% endif %}{% if selected_country %}&country={{ selected_country }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if laser_scanned_only %}&laser_scanned=true{% endif %}"
             hx-get="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_simulator %}&simulator={{ selected_simulator }}{% endif %}{% if selected_country %}&country={{ selected_country }}{% endif %}{% if selected_type %}&type={{ selected_type }}{% endif %}{% if laser_scanned_only %}&laser_scanned=true{% endif %}"
             hx-target="#tracks-container"
             hx-push-url="true"
             class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">
            Next
          </a>
        {% endif %}
      </nav>
    </div>
  {% endif %}
</div>

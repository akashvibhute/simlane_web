{% extends "base.html" %}

{% load static %}
{% load timezone_filters %}

{% block title %}
  {{ event.name }} - SimLane
{% endblock %}
{% block content %}
  <div class="container mx-auto px-4 pb-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400 mb-6">
      <a href="{% url 'events:events_list' %}" class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">Events</a>
      <span>›</span>
      {% if event.series %}
        <a href="{% url 'events:events_list' %}?series={{ event.series.slug }}"
           class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">{{ event.series.name }}</a>
        <span>›</span>
        <span class="text-gray-700 dark:text-gray-300">Season 1</span>
        <span>›</span>
        {% if event.round_number %}
          <span class="text-gray-700 dark:text-gray-300">Round {{ event.round_number|add:1 }}</span>
          <span>›</span>
        {% endif %}
      {% endif %}
      <span class="text-gray-900 dark:text-gray-100">{{ event.name|truncatewords:5 }}</span>
    </nav>

    <!-- Event Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex space-x-4 mb-4">
            {% if event.series and event.series.logo %}
              <img src="{{ event.series.logo.url }}"
                   alt="{{ event.series.name }}"
                   class="h-16 object-contain" />
            {% endif %}
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">{{ event.name }}</h1>
          </div>
          <div class="flex flex-wrap gap-2 items-center">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              {% if event.event_source == 'OFFICIAL' and event.type == 'SPECIAL' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">Official</span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">Special Event</span>
              {% elif event.event_source == 'OFFICIAL' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Official Series</span>
              {% elif event.event_source == 'CLUB' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Club Event</span>
              {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">Community</span>
              {% endif %}
              {% if event.status %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">{{ event.get_status_display }}</span>
              {% endif %}
            </div>
            {% if event.sessions.all %}
              <div class="flex space-x-2 text-sm font-medium">
                {% for session in event.sessions.all %}
                  {% if
                    session.get_session_type_display == 'Practice' or
                    session.get_session_type_display == 'Warmup' %}
                    <div class="flex items-center bg-gray-200 dark:bg-gray-700 rounded-full px-3 py-1 text-gray-600 dark:text-gray-300">
                      <span class="">{{ session.get_session_type_display }} -</span><span class="text-sm font-medium">
                        {% if session.duration %}{{ session.duration }} min{% endif %}
                        {% if session.laps %}{{ session.laps }} laps{% endif %}
                      </span>
                    </div>
                  {% elif session.get_session_type_display == 'Qualifying' %}
                    <div class="flex items-center bg-blue-200 dark:bg-blue-900 rounded-full px-3 py-1 text-blue-600 dark:text-blue-200">
                      <span class="">{{ session.get_session_type_display }} -</span><span class="text-sm font-medium">
                        {% if session.duration %}{{ session.duration }} min{% endif %}
                        {% if session.laps %}{{ session.laps }} laps{% endif %}
                      </span>
                    </div>
                  {% elif session.get_session_type_display == 'Race' %}
                    <div class="flex items-center bg-red-200 dark:bg-red-900 rounded-full px-3 py-1 text-red-600 dark:text-red-200">
                      <span class="">{{ session.get_session_type_display }} -</span><span class="text-sm font-medium">
                        {% if session.duration %}{{ session.duration }} min{% endif %}
                        {% if session.laps %}{{ session.laps }} laps{% endif %}
                      </span>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
        <div class="flex-shrink-0 ml-6 text-center">
          {% if event.simulator.icon %}
            <img src="{{ event.simulator.icon.url }}"
                 alt="{{ event.simulator.name }}"
                 class="w-16 h-16 rounded-lg mx-auto object-contain mb-2" />
          {% endif %}
          <div class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ event.simulator.name }}</div>
        </div>
      </div>
    </div>

    <!-- Mobile/Desktop Layout -->
    <div class="lg:grid lg:grid-cols-3 lg:gap-8">
      <!-- Track Info Sidebar -->
      <aside class="lg:order-2 lg:col-span-1 mb-8 lg:mb-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">
            {{ event.sim_layout.sim_track.track_model.name }} - {{
            event.sim_layout.sim_track.track_model.country }}
          </h2>
          {% if event.sim_layout.name !=
            event.sim_layout.sim_track.track_model.name %}
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">Layout: {{ event.sim_layout.name }}</div>
          {% endif %}
          {% if event.sim_layout.length_km %}
            <div class="text-sm text-gray-600 dark:text-gray-400">Length: {{ event.sim_layout.length_km|floatformat:2 }} km</div>
          {% endif %}
          {% if event.sim_layout.layout_type %}
            <div class="text-sm text-gray-600 dark:text-gray-400">Type: {{ event.sim_layout.get_layout_type_display }}</div>
          {% endif %}
          <div class="relative">
            {% with track=event.sim_layout.sim_track %}
              {% if track.logo %}
                <img src="{{ track.logo.url }}"
                     alt="{{ track.name }} logo"
                     class="absolute bottom-0 left-0 w-16 h-16 object-contain rounded p-1 z-20" />
              {% endif %}
            {% endwith %}
            <!-- Zoom button -->
            <button type="button"
                    class="absolute top-2 right-2 z-30 bg-gray-900 bg-opacity-40 hover:bg-opacity-100 rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer text-white transition-opacity"
                    aria-label="Enlarge track map"
                    id="zoom-track-map-btn">
              <svg xmlns="http://www.w3.org/2000/svg"
                   fill="none"
                   viewBox="0 0 24 24"
                   stroke-width="1.5"
                   stroke="currentColor"
                   class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
              </svg>
            </button>
            {% with svg_layers=event.sim_layout.get_svg_map_layers %}
              {% if
                svg_layers %}
                <div class="relative w-full h-auto max-h-80 bg-gray-700 dark:bg-gray-600 rounded">
                  {% for layer in svg_layers %}
                    {% if forloop.first %}
                      <!-- First image sets intrinsic height -->
                      <img src="{{ layer.image.url }}"
                           alt="{{ layer.caption }}"
                           class="w-full h-auto object-contain" />
                    {% else %}
                      <img src="{{ layer.image.url }}"
                           alt="{{ layer.caption }}"
                           class="absolute inset-0 w-full h-full object-contain"
                           style="z-index:{{ forloop.counter }}" />
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
          </div>
        </div>
        <!-- Requirements -->
        {% if event.min_license_level or event.min_safety_rating or
          event.min_skill_rating %}
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Requirements</h3>
            <div class="space-y-3">
              {% if event.min_license_level %}
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Min License</span><span class="font-medium text-gray-900 dark:text-gray-100">{{ event.min_license_level }}</span>
                </div>
              {% endif %}
              {% if event.min_safety_rating %}
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Min SR</span><span class="font-medium text-gray-900 dark:text-gray-100">{{ event.min_safety_rating|floatformat:2 }}</span>
                </div>
              {% endif %}
              {% if event.min_skill_rating %}
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Min iRating</span><span class="font-medium text-gray-900 dark:text-gray-100">{{ event.min_skill_rating|floatformat:0 }}</span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </aside>

      <!-- Main Content with Tabs -->
      <div class="lg:order-1 lg:col-span-2">
        <!-- Tab Navigation -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
          <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
              <!-- Timeslots Tab (always first) -->
              <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-primary-500 text-primary-600 dark:text-primary-400 active" 
                      data-tab="timeslots"
                      hx-get="{% url 'events:event_timeslots_tab' event.slug %}"
                      hx-target="#tab-content"
                      hx-trigger="click">
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Sessions
              </button>
              
              {% if weather_forecasts %}
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300" 
                        data-tab="weather"
                        hx-get="{% url 'events:event_weather_tab' event.slug %}"
                        hx-target="#tab-content"
                        hx-trigger="click">
                  <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.002 4.002 0 003 15z"></path>
                  </svg>
                  Weather
                </button>
              {% endif %}
              
              {% if class_car_data %}
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"
                        data-tab="cars"
                        hx-get="{% url 'events:event_cars_tab' event.slug %}"
                        hx-target="#tab-content"
                        hx-trigger="click">
                  <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                  </svg>
                  Cars & BOP
                </button>
              {% endif %}
              
              {% if recent_time_slots %}
                <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300"
                        data-tab="results"
                        hx-get="{% url 'events:event_results_tab' event.slug %}"
                        hx-target="#tab-content"
                        hx-trigger="click">
                  <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                  </svg>
                  Results
                </button>
              {% endif %}
              
              <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 lg:hidden"
                      data-tab="layout"
                      hx-get="{% url 'events:event_layout_tab' event.slug %}"
                      hx-target="#tab-content"
                      hx-trigger="click">
                <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
                Track Layout
              </button>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="p-6">
            <div id="tab-content">
              <!-- Default content - will be replaced by HTMX -->
              <div class="flex items-center justify-center h-32">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
                <span class="ml-2 text-gray-600 dark:text-gray-400">Loading sessions...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Zoomed map overlay (hidden by default) -->
  <div id="zoom-track-map-overlay"
       class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="relative bg-gray-900 rounded-lg shadow-lg max-w-3xl w-full p-4">
      <button type="button"
              class="absolute z-50 top-2 right-2 p-2 bg-gray-800 rounded-full cursor-pointer text-white hover:text-red-600 focus:outline-none"
              aria-label="Close zoomed map"
              id="close-zoom-track-map-btn">
        <svg class="w-7 h-7"
             fill="currentColor"
             stroke="currentColor"
             stroke-width="2"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <div class="relative w-full h-auto max-h-[70vh] flex items-center justify-center">
        {% with track=event.sim_layout.sim_track %}
          {% if track.logo %}
            <img src="{{ track.logo.url }}"
                 alt="{{ track.name }} logo"
                 class="absolute bottom-0 left-0 w-20 h-20 object-contain rounded p-1 z-20" />
          {% endif %}
        {% endwith %}
        {% with svg_layers=event.sim_layout.get_svg_map_layers %}
          {% if svg_layers %}
            {% for layer in svg_layers %}
              {% if forloop.first %}
                <img src="{{ layer.image.url }}"
                     alt="{{ layer.caption }}"
                     class="w-full h-auto object-contain" />
              {% else %}
                <img src="{{ layer.image.url }}"
                     alt="{{ layer.caption }}"
                     class="absolute inset-0 w-full h-full object-contain"
                     style="z-index:{{ forloop.counter }}" />
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
{% endblock %}
{% block page_javascript %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Tab functionality
      const tabButtons = document.querySelectorAll('.tab-button');

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {          
          // Remove active classes from all tabs
          tabButtons.forEach(btn => {
            btn.classList.remove('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400');
            btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
          });
          
          // Add active class to clicked tab
          button.classList.add('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400');
          button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        });
      });

      // Load initial tab content - always load timeslots tab first
      htmx.ajax('GET', '{% url "events:event_timeslots_tab" event.slug %}', '#tab-content');

      // Track map zoom overlay logic
      const zoomBtns = [document.getElementById('zoom-track-map-btn'), document.getElementById('zoom-track-map-btn-mobile')];
      const overlay = document.getElementById('zoom-track-map-overlay');
      const closeBtn = document.getElementById('close-zoom-track-map-btn');

      zoomBtns.forEach(zoomBtn => {
        if (zoomBtn && overlay && closeBtn) {
          // Open overlay
          zoomBtn.addEventListener('click', function() {
            overlay.classList.remove('hidden');
            // Trap focus
            closeBtn.focus();
            document.body.style.overflow = 'hidden';
          });
        }
      });

      if (overlay && closeBtn) {
        // Close overlay
        function closeOverlay() {
          overlay.classList.add('hidden');
          document.body.style.overflow = '';
          const activeZoomBtn = document.getElementById('zoom-track-map-btn') || document.getElementById('zoom-track-map-btn-mobile');
          if (activeZoomBtn) activeZoomBtn.focus();
        }
        closeBtn.addEventListener('click', closeOverlay);
        // ESC key closes overlay
        document.addEventListener('keydown', function(e) {
          if (!overlay.classList.contains('hidden') && (e.key === 'Escape' || e.key === 'Esc')) {
            closeOverlay();
          }
        });
        // Click outside closes overlay
        overlay.addEventListener('mousedown', function(e) {
          if (e.target === overlay) {
            closeOverlay();
          }
        });
      }
    });
  </script>
{% endblock %}